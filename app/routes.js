// Generated by CoffeeScript 1.3.3
var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

module.exports = function(app) {
  var characters, die_on_error, fs, ftp, random_name, rest, video_type, _;
  die_on_error = require('./util').die_on_error;
  rest = require('./rest');
  fs = require('fs');
  ftp = require('ftp');
  _ = require('underscore');
  characters = 'abcdefghijklmnopqrstuvwxyz0123456789';
  random_name = function(length) {
    var chars, i;
    chars = (function() {
      var _i, _results;
      _results = [];
      for (i = _i = 0; 0 <= length ? _i < length : _i > length; i = 0 <= length ? ++_i : --_i) {
        _results.push(characters[Math.floor(Math.random() * characters.length)]);
      }
      return _results;
    })();
    return chars.join('');
  };
  video_type = rest.add_type(app, 'video', {});
  app.get('/add_video', function(req, res) {
    return res.render('add_video');
  });
  app.post('/add_video', function(req, res) {
    return fs.readFile(req.files.video.path, function(err, data) {
      var client;
      client = new ftp();
      client.on('ready', function() {
        var key;
        key = "videos/" + (random_name(16)) + ".mp4";
        return client.put(data, key, die_on_error(res, function() {
          client.end();
          return video_type.add({
            video: "http://acsvolleyball.com/" + key
          }, die_on_error(res, function(video) {
            return res.redirect("/stat/" + video.id);
          }));
        }));
      });
      client.on('error', function(err) {
        return res.send(err);
      });
      return client.connect({
        host: 'acsvolleyball.com',
        user: 'acsvolleyball',
        password: 'Voll3yball'
      });
    });
  });
  app.get('/stat/:id', function(req, res) {
    console.log(req.params.id);
    return video_type.get(req.params.id, die_on_error(res, function(video) {
      var _ref;
      console.log(video);
      if ((_ref = video.stats) == null) {
        video.stats = [];
      }
      return res.render('stat', {
        vid: video
      });
    }));
  });
  return app.get('/view/:id', function(req, res) {
    console.log(req.params.id);
    return video_type.get(req.params.id, die_on_error(res, function(video) {
      var players, skill_names, skills, stat, _i, _len, _ref;
      console.log(video);
      _ref = video.stats;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        stat = _ref[_i];
        stat.time = Math.max(0, stat.time - 3);
      }
      players = _.uniq(_(video.stats).map(function(stat) {
        return stat.stat.player;
      }));
      skill_names = _.uniq(_(video.stats).map(function(stat) {
        return stat.stat.skill;
      }));
      skills = _.map(skill_names, function(name) {
        var detail, details, relevant_stats, value, _j, _len1, _ref1, _ref2;
        relevant_stats = _(video.stats).filter(function(stat) {
          return stat.stat.skill === name;
        });
        details = {};
        for (_j = 0, _len1 = relevant_stats.length; _j < _len1; _j++) {
          stat = relevant_stats[_j];
          _ref1 = stat.stat.details;
          for (detail in _ref1) {
            value = _ref1[detail];
            if ((_ref2 = details[detail]) == null) {
              details[detail] = [];
            }
            if (__indexOf.call(details[detail], value) < 0) {
              details[detail].push(value);
            }
          }
        }
        return {
          name: name,
          details: details
        };
      });
      return res.render('view', {
        vid: video,
        players: players,
        skills: skills
      });
    }));
  });
};
